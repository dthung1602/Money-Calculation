{% extends "base.html" %}

{% block heading %}

<h1 style="padding-bottom:25px;padding-left:50px">{{month.time_begin.strftime("%B %Y")}}</h1>
<p style="padding-left:70px"><i>Start date: {{month.time_begin.strftime("%d/%m/%y")}}</i></p>
{% if month.time_end %}
<p style="padding-left:70px"><i>End date : {{month.time_end.strftime("%d/%m/%y")}}</i></p>
{% endif %}
<div style="text-align:right;padding-right:40px"><p class="badge" style="background-color:green;font-size:110%">
    Version 3.0</p></div>

{% endblock %}


{% block content %}

<!-----------------------links----------------------------->
<div align="center">
    <div class="btn-group" style="padding:30px; text-align:center">
        {% if month.prev_month %}
        <button class="btn btn-warning" onclick="window.location='/month/{{month.prev_month.urlsafe()}}'">PREV</button>
        {% else %}
        <button class="btn btn-warning" disabled>PREV</button>
        {% endif %}
        <button class="btn btn-warning" onclick="window.location='/home'">HOME</button>
        {% if month.next_month %}
        <button class="btn btn-warning" onclick="window.location='/month/{{month.next_month.urlsafe()}}'">NEXT</button>
        {% else %}
        <button class="btn btn-warning" disabled>NEXT</button>
        {% endif %}
    </div>
</div>
<br><br>

<!--------------------------items buy in month-------------------------->
<div class="panel panel-primary">
    <div class="panel-heading"><h4><strong>Items</strong></h4></div>
    <table class="table table-striped table-bordered table-hover">
        <!------------------------head-------------------------------->
        <thead>
        <tr>
            <th style="text-align:center">Date</th>
            <th style="text-align:center">Buyer</th>
            <th style="text-align:center">What</th>
            <th style="text-align:center">Price (K)</th>
        </tr>
        </thead>

        <!------------------------items buy in month-------------------------------->
        <tbody id="items">
        {% for item in month.items %}
        <tr>
            <td style="text-align:center">{{item.date.strftime("%d/%m/%y")}}</td>
            <td>{{item.buyer_name}}</td>
            <td>{{item.what}}</td>
            <td style="text-align:right">{{item.price}}</td>
        </tr>
        {% endfor %}
        </tbody>

        <!------------------------------new item--------------------------------------->
        <tfoot>
        {% if not month.time_end %}
        <tr style="background-color:#94D094">
            <td style="text-align: center">
                <button class="btn btn-success" onclick="add()">Add</button>
            </td>
            <td>
                <select id="buyer" title="Buyer" class="form-control" required>
                    {% for b in buyers %}
                    <option value="{{b.key}}" id="{{b.key}}">{{b.name}}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <input id="what" required class="form-control" placeholder="Enter what have been bought">
            </td>
            <td style="width:25%">
                <input id="price" title="Arithmetic expression with + - * / ()" pattern="^[0-9 \+\-\*\/\(\)]+$"
                       required class="form-control" placeholder="Arithmetic expression with + - * / ()">
            </td>
        </tr>
        {% endif %}
        </tfoot>
    </table>
</div>

<!--------------------------error-------------------------->
<div id="errors"></div>

<!--------------------------------- summarize ------------------------------------>
<table class="table" style="font-size:275%;color: #9c9c9c; margin-bottom: 0; background: #f3f3f3; margin-top: 90px">
    <tr>
        <td width="40%" onmouseenter="this.style.background='white'" onmouseleave="this.style.background='#f3f3f3'">
            <span style="margin-right: 40px; font-size: 115%">&nbsp;&nbsp;TOTAL</span>
            <span id="total">{{format_number(month.spend * 1000)[0]}}</span>
        </td>
        <td onmouseenter="this.style.background='white'" onmouseleave="this.style.background='#f3f3f3'">
            <span style="margin-right: 40px; font-size: 115%">&nbsp;&nbsp;AVERAGE</span>
            <span id="average">{{format_number(month.average * 1000)[0]}}.</span>
            <span id="average-float" style="font-size:75%">{{format_number(month.average * 1000)[1]}}</span>
        </td>
    </tr>
</table>
<hr style="margin-top: 0; color: #DDDDDD; border-width: 3px">

<!-----------------------------payments------------------------------>
<div class="panel panel-primary" style="margin-top: 90px">
    <div class="panel-heading"><h4><strong>Payments</strong></h4></div>
    <table class="table table-striped table-bordered table-hover">
        <thead>
        <tr>
            <th style="text-align:center">Name</th>
            <th style="text-align:center">Money spent in month</th>
            <th style="text-align:center">Last month left</th>
            <th style="text-align:center">Payment (*)</th>
            <th style="text-align:center">Payment round up (*)</th>
            <th style="text-align:center">Next month left</th>
        </tr>
        </thead>

        <tbody>
        {% for buyer in buyers %}
        <tr style="text-align:right">
            <td style="text-align:center">{{buyer.name}}</td>
            <td>{{buyer.spend}}</td>
            <td>{{buyer.last_month_left}}</td>
            <td>{{buyer.to_pay}}</td>
            <td>{{buyer.round_up}}</td>
            <td>{{buyer.next_month_left}}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
<br><br>

<!-------------------------------- note ----------------------------------------->
<div class="alert alert-info" style="font-size:120%">
    <strong>Note (*)</strong>
    <ul>
        <li>Positive value means pay</li>
        <li>Negative value means get paid back</li>
    </ul>
</div>

<!--------------------------------end month------------------------------------>
{% if not month.time_end %}
<div class="alert alert-info" style="padding:30px 20px;font-size: 120%;text-align: left">
    <button name="action" value="end" class="btn btn-primary" style="text-align:right">END MONTH</button>
    <strong style="font-size:120%; padding-left: 50px; padding-right: 5px">Warning!</strong>
    <span style="font-size:120%">No data can be added to this month after ending</span>
</div>
{% elif not month.next_month %}
<div class="alert alert-success" style="padding:30px 20px;font-size: 120%;text-align: left">
    <button class="btn btn-success" style="text-align:right" onclick="window.location='/newmonth'">NEW MONTH</button>
    <span style="font-size:120%; padding-left: 50px; padding-right: 5px">Click this button and fill the form to create
        new month</span>
</div>
{% endif %}
<br><br><br><br>

<!-----------------------links----------------------------->
<div align="center">
    <div class="btn-group" style="padding:30px; text-align:center">
        {% if month.prev_month %}
        <button class="btn btn-warning" onclick="window.location='/month/{{month.prev_month.urlsafe()}}'">PREV</button>
        {% else %}
        <button class="btn btn-warning" disabled>PREV</button>
        {% endif %}
        <button class="btn btn-warning" onclick="window.location='/home'">HOME</button>
        {% if month.next_month %}
        <button class="btn btn-warning" onclick="window.location='/month/{{month.next_month.urlsafe()}}'">NEXT</button>
        {% else %}
        <button class="btn btn-warning" disabled>NEXT</button>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block script %}

<!--<script src="/static/js/month.js"></script>-->
<script>
    var numberOfPeope = {{ buyers | length }};
    // var people = {
    //     {% for buyer in buyers %}
    //     {{buyer.key}}: "{{buyer.name}}",
    //     {% endfor %}
    // };
    // alert("obj");

    function addItemToTable(buyer_key, price) {
        // get info
        var buyer_name = document.getElementById(buyer_key).innerText;
        var what = document.getElementById("what").value;
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth() + 1;
        var yyyy = today.getFullYear();
        if (dd < 10) dd = "0" + dd;
        if (mm < 10) mm = "0" + mm;
        var date = dd + "/" + mm + "/" + (yyyy % 1000);

        // add item to table
        var trTag = "<tr><td style='text-align:center'>" +
            date + "</td><td>" +
            buyer_name + "</td><td>" +
            what + "</td><td style='text-align:right'>" +
            price + "</td></tr>";
        document.getElementById("items").innerHTML += trTag;

        // clear old item info
        document.getElementById("buyer").value = "";
        document.getElementById("what").value = "";
        document.getElementById("price").value = "";
    }

    function updateSummarize(itemPrice) {
        alert("update");
        var totalField = document.getElementById("total");
        var total = parseInt(totalField.innerHTML.replace(/\s/g, '')) + itemPrice * 1000;
        var average_int = Math.floor(total / numberOfPeope);
        var average_float = (total / numberOfPeope - average_int).toString().slice(1, 3);
        while (average_float.length < 2)
            average_float += "0";

        totalField.innerHTML = total.toLocaleString().replace(/,/g, " ");
        document.getElementById("average").innerHTML = average_int.toLocaleString().replace(/,/g, " ") + ".";
        document.getElementById("average-float").innerHTML = average_float;
    }

    function updateMoneyUsages() {

    }

    function addSuccess() {
        var buyer_key = document.getElementById("buyer").value;
        var price = eval(document.getElementById("price").value);

        addItemToTable(buyer_key, price);
        updateSummarize(price);
        updateMoneyUsages();
    }

    function displayError(content) {
        var divTag = document.getElementById("errors");
        var errors = content.split(";");
        var errorsFormatted = "";
        for (var i = 0; i < errors.length; i++) {
            errorsFormatted += "<span style='font-size:150%;margin-left: 30px'>" + errors[i] + "</span><br>"
        }
        divTag.innerHTML =
            "<div class='alert alert-danger' style='text-align: left; margin-top: 30px'>" +
            "<table><tr><td>" +
            "<img src='/static/images/error.png' height='55px'>" +
            "<strong style='font-size:150%;margin-left: 20px'>ERROR!</strong>" +
            "</td><td style='font-size: 90%'>" +
            errorsFormatted +
            "</td></tr></table></div>"
    }


    function add() {
        var buyer = document.getElementById("buyer").value;
        var what = document.getElementById("what").value;
        var price = document.getElementById("price").value;
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState !== 4)
                return;
            if (this.status === 200)
                addSuccess();
            else if (this.status === 409)
                displayError(xhttp.responseText)
        };
        xhttp.open("POST", "/month/");
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhttp.send(
            "action=add&" +
            "buyer=" + encodeURI(buyer) + "&" +
            "what=" + encodeURI(what) + "&" +
            "price=" + encodeURI(price)
        )
    }

</script>

{% endblock %}